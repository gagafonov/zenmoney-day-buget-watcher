# Zenmoney Day Budget Watcher

Приложение для мониторинга дневного бюджета с интеграцией Telegram для уведомлений о расходах. Приложение отслеживает фактические расходы через API Zenmoney и отправляет уведомления при превышении установленного лимита.

## Описание функциональности

### Основные функции

1. **Мониторинг расходов**
   - Периодическая проверка фактических расходов через API Zenmoney
   - Сравнение фактических расходов с расчетным бюджетом
   - Отслеживание изменений сумм расходов в реальном времени

2. **Уведомления о превышении бюджета**
   - Отправка предупреждения в Telegram при превышении лимита расходов
   - Информация о размере перерасхода, фактическом и расчетном расходе
   - Механизм блокировки повторных уведомлений (через lock-файлы)

3. **Ежедневные сводки**
   - Отправка дневной сводки по бюджету в установленное время
   - Информация о расчетной дневной сумме и доступном остатке

4. **Резервное копирование плана расходов**
   - Автоматическое создание резервной копии плана расходов (reminder)
   - Отправка JSON-файла в Telegram в установленное время

5. **Управление состоянием**
   - Автоматическая очистка lock-файлов в определенное время суток
   - Механизм предотвращения дублирования уведомлений

## Архитектура

### Файловая структура

```
app/
├── app.rb           # Главное приложение с основной логикой
└── utils.rb         # Утилиты для работы с Telegram API
```

### Компоненты

#### [app/app.rb](app/app.rb)
Основной скрипт приложения, содержит:

- Инициализацию переменных из переменных окружения
- Основной цикл мониторинга (while true)
- Логику обработки данных от API Zenmoney
- Вызовы функций отправки уведомлений в Telegram

#### [app/utils.rb](app/utils.rb)
Вспомогательные функции:

- `telegramMessageSend()` - отправка текстовых сообщений в Telegram
- `telegramJsonSend()` - отправка JSON-файлов в Telegram
- `numberFormat()` - форматирование чисел с разделением по тысячам

## Настройки (переменные окружения)

Все настройки хранятся в файле `.env` и загружаются в контейнер Docker.

### Настройки бюджета

| Переменная | Тип | Описание | Пример |
|---|---|---|---|
| `APP_OUTCOME_TOTAL` | integer | **Общий месячный лимит расходов** (если используется этот вариант вместо `APP_OUTCOME_PER_DAY`). Приложение автоматически рассчитает дневной лимит путем деления на количество дней в месяце | `120000` |
| `APP_OUTCOME_PER_DAY` | integer | **Дневной лимит расходов** (приоритетнее `APP_OUTCOME_TOTAL`). Если установлен, игнорирует `APP_OUTCOME_TOTAL` | `4000` |

### Настройки отправки уведомлений

| Переменная | Тип | Описание | Пример |
|---|---|---|---|
| `APP_BACKUP_SPENDING_PLANS_ENABLED` | boolean | **Включить резервное копирование плана расходов?** Если `true`, приложение будет отправлять JSON-файл с планом расходов в указанное время | `true` |
| `APP_BACKUP_SPENDING_PLANS_MESSAGGE_SEND_HOUR` | integer | **Час отправки резервной копии плана** (0-23 в формате UTC, указанном в `TZ`) | `12` |
| `APP_SUMMARY_MESSAGE_SEND_HOUR` | integer | **Час отправки дневной сводки по бюджету** (0-23) | `4` |

### Настройки хранения данных

| Переменная | Тип | Описание | Пример |
|---|---|---|---|
| `APP_TMP_DIR` | string | **Директория для временных файлов и lock-файлов** (должна совпадать с томом в docker-compose.yml) | `/tmp/app` |
| `APP_CLEAR_ALL_LOCKS_TIME` | string | **Время ежедневной очистки lock-файлов** в формате `HH:MM`. После этого времени уведомления сможут отправляться повторно | `17:59` |
| `APP_DEBUG` | boolean | **Режим отладки**. Если `true`, сообщения выводятся в консоль вместо отправки в Telegram | `true` |

### Настройки Zenmoney API

| Переменная | Тип | Описание | Пример |
|---|---|---|---|
| `ZENMONEY_API_URL` | string | **URL API Zenmoney** для получения данных о транзакциях | `https://zenmoney.ru/api/v8/diff` |
| `ZENMONEY_API_TOKEN` | string | **Токен доступа API Zenmoney**. Получить можно на сайте [zerro.app/token](https://zerro.app/token) | `<YOUR_ZENMONEY_TOKEN>` |
| `ZENMONEY_CHECK_TIMEOUT` | integer | **Интервал проверки расходов в секундах**. Как часто приложение будет запрашивать API Zenmoney | `10` |
| `ZENMONEY_CHECK_ACCOUNTS` | string | **UUID счетов для отслеживания** (через запятую без пробелов). Указываются только счета, расходы которых нужно контролировать | `<YOUR_ACCOUNT_UUID>` |
| `ZENMONEY_CHECK_EXCLUDE_INCOME_ACCOUNTS` | string | **UUID счетов для исключения доходов** (через запятую без пробелов). Исключает денежные переводы с указанных счетов из расчета расходов | `<YOUR_ACCOUNT_UUID1>,<YOUR_ACCOUNT_UUID2>` |

### Настройки Telegram Bot

| Переменная | Тип | Описание | Пример |
|---|---|---|---|
| `TELEGRAM_BOT_ID` | string | **ID Telegram bot** (числовой идентификатор) | `<YOUR_BOT_ID>` |
| `TELEGRAM_BOT_TOKEN` | string | **Токен Telegram bot** (получить от @BotFather) | `<YOUR_BOT_TOKEN>` |
| `TELEGRAM_SUMMARY_CHAT_ID` | string | **Chat ID для дневной сводки по бюджету** (отрицательное число для групп) | `<YOUR_CHAT_ID>` |
| `TELEGRAM_WARNINGS_CHAT_ID` | string | **Chat ID для предупреждений о превышении бюджета** (отрицательное число для групп) | `<YOUR_CHAT_ID>` |
| `TELEGRAM_NOTICES_CHAT_ID` | string | **Chat ID для уведомлений и информационных сообщений** (может быть ID личного чата) | `<YOUR_CHAT_ID>` |

### Системные настройки

| Переменная | Тип | Описание | Пример |
|---|---|---|---|
| `TZ` | string | **Временная зона** для правильного определения текущей даты и времени отправки уведомлений | `UTC` |

## Механизм работы

### Основной цикл

```
1. Получить текущее время и дату
2. Рассчитать дневной лимит (если не установлен)
3. Проверить, не пришло ли время очистки lock-файлов
4. Получить данные о транзакциях от Zenmoney API
5. Отфильтровать транзакции по счетам и исключениям
6. Сравнить фактические расходы с лимитом
7. Отправить необходимые уведомления в Telegram
8. Ждать ZENMONEY_CHECK_TIMEOUT секунд
9. Повторить цикл
```

### Lock-файлы

Для предотвращения отправки дублирующихся уведомлений используются lock-файлы:

- **`telegram_outcome_not_math.lock`** - блокирует повторные предупреждения о превышении бюджета
- **`telegram_day_summary.lock`** - блокирует повторную отправку дневной сводки
- **`telegram_reminder_marker_backup.lock`** - блокирует повторную отправку резервной копии

Эти файлы автоматически удаляются в время, указанное в `APP_CLEAR_ALL_LOCKS_TIME`.

## Запуск

### С помощью Docker Compose

```bash
docker-compose up -d
```

Это запустит приложение в контейнере с автоматическим перезапуском при ошибке.

### Локально (без Docker)

```bash
ruby app/app.rb
```

## Требования

- Ruby 3.2.9+ (см. в [docker-compose.yml](docker-compose.yml))
- Gem: json, net/http, uri, fileutils (встроенные в Ruby)
- Активный API токен Zenmoney
- Telegram Bot с токеном для отправки сообщений

## Логирование

Приложение выводит логи в консоль с информацией о:
- Процессе проверки расходов
- Отправке уведомлений
- Ошибках подключения к API
- Очистке lock-файлов

В Docker Compose логирование настроено с ограничением размера файла (max 5 файлов по 1MB).

## Примеры использования

### Сценарий 1: Простой мониторинг дневного бюджета

```env
APP_OUTCOME_PER_DAY=4000
APP_SUMMARY_MESSAGE_SEND_HOUR=9
ZENMONEY_CHECK_TIMEOUT=5
```

Приложение будет отслеживать, чтобы ежедневные расходы не превышали 4000р, и отправлять сводку в 9:00 UTC.

### Сценарий 2: Мониторинг месячного бюджета

```env
APP_OUTCOME_TOTAL=120000
APP_CLEAR_ALL_LOCKS_TIME=00:00
ZENMONEY_CHECK_TIMEOUT=10
```

Приложение разделит месячный бюджет 120000р на дни месяца и будет проверять, чтобы не было перерасхода. Lock-файлы очищаются в полночь.

## Структура Telegram сообщений

### Предупреждение о превышении
```
Внимание: фактический расход больше расчетного!

→ Перерасход: 500р
→ Фактический расход: 4500р
→ Расчетный расход: 4000р
```

### Уведомление об изменении расходов
```
Изменение суммы расхода: 3000р → 3500р
Сумма расхода: 500р
Сумма, реально доступная для расхода: 500р
```

### Дневная сводка
```
Бюджет на день

→ Расчетная дневная сумма расхода: 4000р
→ Сумма, реально доступная для расхода: 1500р
```
